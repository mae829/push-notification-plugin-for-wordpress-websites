<?php

/**
* Ajax routine to Store Device id token generated from Google's FireBase 
* based on user subscription from browser to allow push notifications. 
* Device id is generated by Google's Firebase.
*
* @param string   $_POST['device_id'] Device id sent from firebase ajax routine
*
*
* @since 1.0.0
*/

	/** Sanitize the device id generated by Google's Firebase for the user who subscribed push notification  **/
	
    $bpdeviceid = sanitize_text_field($_POST['device_id']);
	
	/** securing data from Firebase who subscribed push notification  **/
	
	$bpdeviceid = esc_html($bpdeviceid);
	
	$pushtype = 'normal';
	
	global $wpdb;
	
	if (isset($_POST['pushtype'])) {
	
	    $pushtype = sanitize_text_field($_POST['pushtype']);
	
	    $pushtype = esc_html($pushtype);
	    
	}

	$bpuserid = 0;
	
	if ( is_user_logged_in() ) {
    	$bpuserid = get_current_user_id();
	}
    
	if ($bpdeviceid != '' && $pushtype == 'normal') {
	
		$table = $wpdb->prefix.'pnfpb_ic_subscribed_deviceids_web';
		
		$deviceid_exists = $wpdb->get_results("SELECT * FROM $table WHERE device_id LIKE '%".$bpdeviceid."%'"  ) ;
		
		foreach( $deviceid_exists as $result ) {

				if ($result->userid == 0){

					$deviceid_update_status = $wpdb->query("UPDATE $table SET userid = {$bpuserid} WHERE device_id = '{$bpdeviceid}'") ;	
				}  
		}		
	
		if(count($deviceid_exists) > 0) {
			echo "duplicate";
		}
		else
		{
			$data = array('userid' => $bpuserid, 'device_id' => $bpdeviceid);
			$insertstatus = $wpdb->insert($table,$data);
			if (!$insertstatus || $insertstatus != 0){
				$my_id = $wpdb->insert_id;
				echo 'subscribed';
			}
			else
			{
				echo "fail";
			}
		}
	}
	else
	{
		if ($bpdeviceid != '' && $pushtype == 'subscribe-button') {
		    
		    $table = $wpdb->prefix.'pnfpb_ic_subscribed_deviceids_web';
		
		    $newbpdeviceid = $bpdeviceid.'@N';
		
		    $deviceid_update_status = $wpdb->query("UPDATE {$table} SET device_id = '{$bpdeviceid}' WHERE device_id = '{$newbpdeviceid}'") ;
		
		    if($deviceid_update_status > 0) {
		    
			    echo "subscribed";
			
		    }
		    else
		    {
				$bpdeviceid = $bpdeviceid;
			    $data = array('userid' => $bpuserid, 'device_id' => $bpdeviceid);
			    $insertstatus = $wpdb->insert($table,$data);
			    if (!$insertstatus || $insertstatus != 0){
				    $my_id = $wpdb->insert_id;
				    echo 'subscribed';
			    }
			    else
			    {
				    echo "fail";
			    }
		    }		    
		}
		else
		{
		    
		    if ($bpdeviceid != '' && $pushtype == 'checkdeviceid') {

		        $table = $wpdb->prefix.'pnfpb_ic_subscribed_deviceids_web';
		
		        $deviceid_select_status = $wpdb->get_results("SELECT * FROM {$table} WHERE device_id LIKE '%".$bpdeviceid."%'");

				foreach( $deviceid_select_status as $result ) {

					if ($result->userid == 0){

						$deviceid_update_status = $wpdb->query("UPDATE {$table} SET userid = {$bpuserid} WHERE device_id = '{$bpdeviceid}'") ;	
					} 
				}			
		
		        if(count($deviceid_select_status) > 0) {
		    
			        echo "subscribed";
			
		        }
		        else
		        {
					$data = array('userid' => $bpuserid, 'device_id' => $bpdeviceid);
					$insertstatus = $wpdb->insert($table,$data);
					if (!$insertstatus || $insertstatus != 0){
						$my_id = $wpdb->insert_id;
						echo 'subscribed';
					}
					else
					{
						echo "not-subscribed";
					}
		        }		        
		        
		    }
		    
		    else
		    {
		    	if ($bpdeviceid != '' && $pushtype == 'checkdeviceidforgroup') {
					
					$bpgroupid = sanitize_text_field($_POST['bpgroup_id']);

		        	$table = $wpdb->prefix.'pnfpb_ic_subscribed_deviceids_web';
		
		        	$deviceid_select_status = $wpdb->query("SELECT * FROM {$table} WHERE device_id = '{$bpdeviceid}!!{$bpgroupid}' AND userid = {$bpuserid}") ;
					//print_r($deviceid_select_status);
		        	if($deviceid_select_status > 0) {
		    
			        	echo "subscribed";
			
		        	}
		        	else
		        	{
			        	echo "not-subscribed";
		        	}		        
		        
		    	}
				else
				{
		    		if ($bpdeviceid != '' && $pushtype == 'subscribe-group-button') {
						
						$bpgroupid = sanitize_text_field($_POST['bpgroup_id']);

		    			$table = $wpdb->prefix.'pnfpb_ic_subscribed_deviceids_web';
						
						$cookievalue = '';
						if(!isset($_COOKIE[$cookie_name])) {
							$cookievalue = $_COOKIE['pnfpb_group_push_notification_'.$bpgroupid];
						}
						
						$bpnewdeviceid = $bpdeviceid.'!!'.$bpgroupid.'!!'.$cookievalue;
		
		    			$bpolddeviceid = $bpdeviceid.'!!'.$bpgroupid.'!!'.$cookievalue.'@N';
		
		    			$deviceid_update_status = $wpdb->query("UPDATE {$table} SET device_id = '{$bpnewdeviceid}' WHERE device_id = '{$bpolddeviceid}' AND userid = {$bpuserid}") ;
		
		    			if($deviceid_update_status > 0) {
		    
			    			echo "subscribed";
			
		    			}
		    			else
		   				{
							$uniqueid = uniqid();
							setcookie('pnfpb_group_push_notification_'.$bpgroupid, $uniqueid, time() + (86400 * 30), "/"); // 86400 = 1 day
							$bpnewdeviceid = $bpdeviceid.'!!'.$bpgroupid.'!!'.$uniqueid;
			    			$data = array('userid' => $bpuserid, 'device_id' => $bpnewdeviceid);
			    			$insertstatus = $wpdb->insert($table,$data);
			    			if (!$insertstatus || $insertstatus != 0){
				    			$my_id = $wpdb->insert_id;
				    			echo 'subscribed';
			    			}
			    			else
			    			{
				    			echo "fail";
			    			}
		    			}		        
		        
		    		}
					else
					{
		    			if ($bpdeviceid != '' && $pushtype == 'unsubscribe-group-button') {
						
							$bpgroupid = sanitize_text_field($_POST['bpgroup_id']);

		    				$table = $wpdb->prefix.'pnfpb_ic_subscribed_deviceids_web';

							$cookievalue = '';
							if(!isset($_COOKIE[$cookie_name])) {
								$cookievalue = $_COOKIE['pnfpb_group_push_notification_'.$bpgroupid];
							}							
		
							$bpolddeviceid = $bpdeviceid.'!!'.$bpgroupid.'!!'.$cookievalue;
		
		    				//$bpnewdeviceid = $bpdeviceid.'!!'.$bpgroupid.'!!'.$cookievalue.'@N';
		
		    				$deviceid_update_status = $wpdb->query("DELETE from {$table} WHERE userid = {$bpuserid} AND device_id = '{$bpolddeviceid}'") ;
		
		    				if($deviceid_update_status > 0) {
		    
			    				echo "unsubscribed";
			
		    				}
		    				else
		   					{
				    				echo "fail";
		    				}		        
		        
		    			}
						else
						{
                			echo "fail";		    
						}		    
					}
				}
		    }
		}
		
	}
	
?>